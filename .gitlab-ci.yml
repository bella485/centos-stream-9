stages:
  - build
  - check

build:
  image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/golang:alpine3.12
  stage: build
  before_script:
    - apk add make
  script:
    - cd scripts
    - make
  artifacts:
    paths:
      - scripts/RHMAINTAINERS_parser
      - scripts/yaml2CODEOWNERS
      - scripts/yaml2RHMAINTAINERS

check:
  image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/alpine:latest
  stage: check
  needs:
    - build
  before_script:
    - apk add git
  script:
    # rebuild the current files
    - ./scripts/yaml2CODEOWNERS info/owners.yaml > info/CODEOWNERS
    - ./scripts/yaml2RHMAINTAINERS info/owners.yaml > info/RHMAINTAINERS

    # clean up cache
    - rm -f .failed

    # check that the committed files matched
    - git diff --exit-code || touch .failed
    - |
      if [[ -e .failed ]]
      then
        echo '-----------------------------------------------------------------'
        echo ''
        echo ' Looks like the files scripts/CODEOWNERS or scripts/RHMAINTAINERS'
        echo ' have not been regenerated and checked in this commit.'
        echo ''
        echo ' Please run the following command before committing:'
        echo '        ./scripts/yaml2CODEOWNERS info/owners.yaml > info/CODEOWNERS'
        echo '        ./scripts/yaml2RHMAINTAINERS info/owners.yaml > info/RHMAINTAINERS'
        echo ''
        echo '-----------------------------------------------------------------'
        exit 1
      fi
